name: Claude Code Processor

on:
  workflow_dispatch:
    inputs:
      question:
        description: "User question from Slack"
        required: true
        type: string
      mcp_tools:
        description: "Comma-separated list of MCP tools to enable"
        required: false
        type: string
        default: "slack"
      slack_channel:
        description: "Slack channel ID"
        required: true
        type: string
      slack_ts:
        description: "Slack message timestamp (placeholder)"
        required: true
        type: string
      slack_thread_ts:
        description: "Slack thread timestamp"
        required: false
        type: string
      system_prompt:
        description: "System prompt with thread context"
        required: false
        type: string

jobs:
  run-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Prepare MCP configuration
        run: |
          cat > mcp-config.json <<'EOF'
          {
            "mcpServers": {
              "slack": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-slack"],
                "env": {
                  "SLACK_BOT_TOKEN": "${{ secrets.SLACK_BOT_TOKEN }}",
                  "SLACK_TEAM_ID": "${{ secrets.SLACK_TEAM_ID }}"
                }
              },
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_TOKEN": "${{ secrets.GH_TOKEN }}"
                }
              },
              "notionApi": {
                "command": "npx",
                "args": ["-y", "@notionhq/notion-mcp-server"],
                "env": {
                  "OPENAPI_MCP_HEADERS": "{\"Authorization\":\"Bearer ${{ secrets.NOTION_KEY }}\",\"Notion-Version\":\"2022-06-28\"}"
                }
              }
            }
          }
          EOF
          echo "MCP configuration created"
      
      - name: Run Claude Code
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            You are helping a user in Slack. Here is the context:
            ${{ github.event.inputs.system_prompt }}
            
            User question: ${{ github.event.inputs.question }}
            
            Please provide a helpful response to the user's question.
            
            CRITICAL: After you have prepared your response, you MUST update the Slack message by calling the mcp__slack__chat_update tool with these parameters:
            - channel: "${{ github.event.inputs.slack_channel }}"
            - ts: "${{ github.event.inputs.slack_ts }}"
            - text: (your complete response to the user)
            
            The mcp__slack__chat_update call should be your FINAL action.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          mcp_config: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "${{ secrets.SLACK_BOT_TOKEN }}",
                    "SLACK_TEAM_ID": "${{ secrets.SLACK_TEAM_ID }}"
                  }
                }
              }
            }
          allowed_tools: "${{ github.event.inputs.mcp_tools }},Bash,Grep,Glob,Read,Write,Edit,MultiEdit,LS,Task,TodoRead,TodoWrite,WebSearch,WebFetch"
          max_turns: 10