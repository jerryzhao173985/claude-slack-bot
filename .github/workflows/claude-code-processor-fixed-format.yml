name: Claude Code Processor Fixed Format

on:
  workflow_dispatch:
    inputs:
      question:
        description: "User question from Slack"
        required: true
        type: string
      mcp_tools:
        description: "Comma-separated list of MCP tools to enable"
        required: false
        type: string
        default: "slack"
      slack_channel:
        description: "Slack channel ID"
        required: true
        type: string
      slack_ts:
        description: "Slack message timestamp (placeholder)"
        required: true
        type: string
      slack_thread_ts:
        description: "Slack thread timestamp"
        required: false
        type: string
      system_prompt:
        description: "System prompt with thread context"
        required: false
        type: string

jobs:
  run-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create output directory
        run: mkdir -p outputs
      
      - name: Run Claude Code with Correct Format
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            You are a helpful Slack bot assistant. A user has asked you a question in Slack.
            
            User question: ${{ github.event.inputs.question }}
            
            Please provide a helpful and concise response to the user's question.
            
            IMPORTANT: Save your complete response to the file outputs/slack_response.txt
            This file will be used to update the Slack message.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          anthropic_model: claude-3-5-sonnet-20241022
          # Use comma-separated format as per claude --help
          allowed_tools: "Write,Read,Bash,Edit,MultiEdit,Glob,Grep,LS,Task,TodoRead,TodoWrite,WebSearch,WebFetch,mcp__slack__slack_post_message,mcp__slack__slack_reply_to_thread,mcp__slack__slack_add_reaction,mcp__slack__slack_get_channel_history,mcp__slack__slack_get_thread_replies,mcp__slack__slack_get_users,mcp__slack__slack_get_user_profile,mcp__slack__slack_list_channels"
          mcp_config: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "${{ secrets.SLACK_BOT_TOKEN }}",
                    "SLACK_TEAM_ID": "${{ secrets.SLACK_TEAM_ID }}"
                  }
                }
              }
            }
          max_turns: 10
          claude_env: |
            ANTHROPIC_PROMPT_CACHING=1
            CLAUDE_CODE_AUTORUN_TOOLS=true
      
      - name: Update Slack Message
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          # Check if Claude created the response file
          if [ -f "outputs/slack_response.txt" ]; then
            echo "✅ Found response file"
            RESPONSE=$(cat outputs/slack_response.txt)
          else
            echo "❌ Response file not found, using default"
            RESPONSE="I've processed your request. Please check the action logs for details."
          fi
          
          # Escape the response for JSON
          ESCAPED_RESPONSE=$(echo "$RESPONSE" | jq -Rs .)
          
          # Update the Slack message
          echo "Updating Slack message..."
          UPDATE_RESULT=$(curl -s -X POST https://slack.com/api/chat.update \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"${{ github.event.inputs.slack_channel }}\",
              \"ts\": \"${{ github.event.inputs.slack_ts }}\",
              \"text\": $ESCAPED_RESPONSE
            }")
          
          # Check result
          if echo "$UPDATE_RESULT" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "✅ Successfully updated Slack message"
          else
            echo "❌ Failed to update message: $(echo "$UPDATE_RESULT" | jq -r '.error // "unknown"')"
            
            # Try posting as reply
            echo "Posting as reply instead..."
            curl -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"channel\": \"${{ github.event.inputs.slack_channel }}\",
                \"thread_ts\": \"${{ github.event.inputs.slack_thread_ts || github.event.inputs.slack_ts }}\",
                \"text\": $ESCAPED_RESPONSE
              }"
          fi