name: Claude Code Processor Skip Permissions

on:
  workflow_dispatch:
    inputs:
      question:
        description: "User question from Slack"
        required: true
        type: string
      slack_channel:
        description: "Slack channel ID"
        required: true
        type: string
      slack_ts:
        description: "Slack message timestamp (placeholder)"
        required: true
        type: string
      slack_thread_ts:
        description: "Slack thread timestamp"
        required: false
        type: string

jobs:
  run-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create output directory
        run: mkdir -p outputs
      
      - name: Run Claude Code with Skip Permissions
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            You are a helpful Slack bot assistant. Answer this question: ${{ github.event.inputs.question }}
            
            Save your complete response to: outputs/slack_response.txt
            
            Make sure the response is clear, helpful, and properly formatted for Slack.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          anthropic_model: claude-3-5-sonnet-20241022
          # Skip all permission checks
          allowed_tools: "Write"
          max_turns: 5
          claude_env: |
            ANTHROPIC_PROMPT_CACHING=1
            CLAUDE_CODE_DANGEROUSLY_SKIP_PERMISSIONS=true
      
      - name: Update Slack Message
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          # Check if response file exists
          if [ -f "outputs/slack_response.txt" ]; then
            echo "✅ Found response file"
            RESPONSE=$(cat outputs/slack_response.txt)
          else
            echo "❌ No response file, checking for any .txt files..."
            find . -name "*.txt" -type f -exec echo "Found: {}" \; -exec head -50 {} \;
            RESPONSE="I apologize, but I couldn't save my response properly. Please check the logs."
          fi
          
          # Update Slack
          ESCAPED_RESPONSE=$(echo "$RESPONSE" | jq -Rs .)
          
          UPDATE_RESULT=$(curl -s -X POST https://slack.com/api/chat.update \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"${{ github.event.inputs.slack_channel }}\",
              \"ts\": \"${{ github.event.inputs.slack_ts }}\",
              \"text\": $ESCAPED_RESPONSE
            }")
          
          if echo "$UPDATE_RESULT" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "✅ Updated Slack successfully"
          else
            echo "❌ Update failed: $(echo "$UPDATE_RESULT" | jq -r '.error')"
            # Post as reply
            curl -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"channel\": \"${{ github.event.inputs.slack_channel }}\",
                \"thread_ts\": \"${{ github.event.inputs.slack_thread_ts || github.event.inputs.slack_ts }}\",
                \"text\": $ESCAPED_RESPONSE
              }"
          fi