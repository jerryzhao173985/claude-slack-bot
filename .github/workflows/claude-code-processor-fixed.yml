name: Claude Code Processor Fixed

on:
  workflow_dispatch:
    inputs:
      question:
        description: "User question from Slack"
        required: true
        type: string
      mcp_tools:
        description: "Comma-separated list of MCP tools to enable"
        required: false
        type: string
        default: "slack"
      slack_channel:
        description: "Slack channel ID"
        required: true
        type: string
      slack_ts:
        description: "Slack message timestamp (placeholder)"
        required: true
        type: string
      slack_thread_ts:
        description: "Slack thread timestamp"
        required: false
        type: string
      system_prompt:
        description: "System prompt with thread context"
        required: false
        type: string

jobs:
  run-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Claude Code with MCP
        id: claude
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            You are a helpful Slack bot assistant. A user has asked you a question.
            
            Question: ${{ github.event.inputs.question }}
            
            ${{ github.event.inputs.system_prompt }}
            
            Please provide a helpful, concise response to the user's question.
            
            After you have formulated your response, use the mcp__slack__slack_reply_to_thread tool to send your answer:
            - channel_id: "${{ github.event.inputs.slack_channel }}"
            - thread_ts: "${{ github.event.inputs.slack_thread_ts || github.event.inputs.slack_ts }}"
            - text: (your complete response)
            
            IMPORTANT: Use slack_reply_to_thread (not post_message or chat_update) to respond in the same thread.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          anthropic_model: claude-3-7-sonnet-20250219
          mcp_config: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "${{ secrets.SLACK_BOT_TOKEN }}",
                    "SLACK_TEAM_ID": "${{ secrets.SLACK_TEAM_ID }}"
                  }
                }
              }
            }
          allowed_tools: "ALL"
          max_turns: 10
          claude_env: |
            ANTHROPIC_PROMPT_CACHING=1
            CLAUDE_CODE_AUTORUN_TOOLS=true
      
      - name: Update placeholder if needed
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          # Check if Claude successfully replied
          # If not, update the placeholder with an error message
          if [ "${{ steps.claude.outcome }}" != "success" ]; then
            curl -X POST https://slack.com/api/chat.update \
              -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{
                "channel": "${{ github.event.inputs.slack_channel }}",
                "ts": "${{ github.event.inputs.slack_ts }}",
                "text": "❌ Sorry, I encountered an error processing your request. Please try again."
              }'
          else
            # Update placeholder to indicate response is in thread
            curl -X POST https://slack.com/api/chat.update \
              -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{
                "channel": "${{ github.event.inputs.slack_channel }}",
                "ts": "${{ github.event.inputs.slack_ts }}",
                "text": "✅ Responded in thread"
              }'
          fi